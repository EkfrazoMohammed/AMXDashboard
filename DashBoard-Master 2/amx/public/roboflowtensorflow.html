<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Webcam Object Detection</title>
</head>

<body>
    <style>
        h1 {
            font-family: "Poppins", sans-serif;
            font-size: 1.4rem;
            color: #525f7f;
            font-weight: 600;
        }

        canvas {
            z-index: 100;
            position: absolute;
            top: 0;
            left: 0;
        }
    </style>
    <video muted autoplay loop id="video" playsinline width="540" height="420"></video>
    <canvas id="outputCanvas" width="560" height="420" style="display:none;"></canvas>
    <br>
    <button id="startButton">Start Detection</button>

    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow-models/coco-ssd"></script>

    <script>
        const videoOutput = document.getElementById('video');
        videoOutput.src = "https://uploads-ssl.webflow.com/5f6bc60e665f54545a1e52a5/63d15cb160518f7f9c59a892_Sequence 01-transcode.mp4";
        const canvas = document.getElementById('outputCanvas');
        const ctx = canvas.getContext('2d');
        const startButton = document.getElementById('startButton');
        let model;

        // Array of color choices for bounding boxes and text background
        const color_choices = [
            "#00FFCE",
            // "#FF0000",
            // "#0000FF",
            // "#FFFF00",
            // "#FF00FF",
        ];

        // Load the COCO-SSD model
        cocoSsd.load().then((loadedModel) => {
            model = loadedModel;
            console.log("Model loaded successfully");
        });

        // Start the webcam stream when the button is clicked
        startButton.addEventListener('click', () => {
            startWebcam();
            canvas.style.display = 'block';
        });

        function startWebcam() {
            if (navigator.mediaDevices.getUserMedia) {
                navigator.mediaDevices.getUserMedia({ video: true })
                    .then((stream) => {
                        videoOutput.srcObject = stream; // Set the webcam stream as the video source
                        videoOutput.onloadedmetadata = () => {
                            videoOutput.play();
                            detectObjects(); // Start object detection only after video is playing
                        };
                    })
                    .catch((err) => {
                        console.error("Error accessing the webcam: ", err);
                    });
            } else {
                console.error("getUserMedia not supported in this browser.");
            }
        }

        // Object detection loop
        function detectObjects() {
            model.detect(videoOutput).then((predictions) => {
                // Draw the video frame first
                ctx.drawImage(videoOutput, 0, 0, canvas.width, canvas.height);

                // Draw the bounding boxes
                predictions.forEach(prediction => {
                    const [x, y, width, height] = prediction.bbox;
                    const color = color_choices[Math.floor(Math.random() * color_choices.length)];

                    // Draw bounding box
                    ctx.beginPath();
                    ctx.rect(x, y, width, height);
                    ctx.lineWidth = 4;  // Thicker box
                    ctx.strokeStyle = color;
                    ctx.stroke();

                    // Draw filled background for text
                    ctx.fillStyle = color;
                    const text = `${prediction.class} (${Math.round(prediction.score * 100)}%)`;
                    const textWidth = ctx.measureText(text).width;
                    ctx.fillRect(x, y > 10 ? y - 20 : y + 5, textWidth + 10, 20);

                    // Draw text
                    ctx.font = "18px Arial";
                    ctx.fillStyle = "white";  // Text color
                    ctx.fillText(text, x + 5, y > 10 ? y - 5 : y + 20);
                });

                // Continue to detect objects on the next frame
                requestAnimationFrame(detectObjects);
            });
        }
    </script>
</body>

</html>